<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excellence Tutorial CBT Portal</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Canva Data SDK (Public Working Link) -->
  <script src="https://unpkg.com/@canva/data-sdk@latest/dist/data-sdk.min.js"></script>

  <style>
    body { margin: 0; padding: 0; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    html { height: 100%; }
    .glass { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1.5rem; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37); }
    .glass-dark { background: rgba(0, 0, 0, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
    .question-nav-btn { transition: all 0.3s ease; }
    .question-nav-btn:hover { transform: scale(1.15); }
    .answered { background: rgba(34, 197, 94, 0.4); border: 2px solid #22c55e; }
    .current { background: rgba(59, 130, 246, 0.6); border: 2px solid #3b82f6; }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin: 2rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .grade-A { background: #22c55e; } .grade-B { background: #3b82f6; } .grade-C { background: #eab308; } .grade-D { background: #f97316; } .grade-F { background: #ef4444; }
    .grade-badge { padding: 0.5rem 1.2rem; border-radius: 999px; font-weight: bold; color: white; font-size: 1.1rem; }
  </style>
</head>
<body class="w-full text-white">
  <div id="app" class="w-full min-h-screen p-4"></div>

  <script>
    // ==============================================
    // EXCELLENCE TUTORIAL CBT PORTAL - FINAL VERSION
    // Secure • No Public Login Hints • Professional
    // ==============================================

    let currentUser = null, currentView = 'login';
    let selectedSubjects = [], completedSubjects = JSON.parse(localStorage.getItem('completed') || '[]');
    let currentSubject = null, currentQuestionIndex = 0, userAnswers = {};
    let timerInterval = null, timeRemaining = 0, tabSwitchCount = 0;
    let allAttempts = [], currentExamQuestions = [], dataSdkInitialized = false;

    // Secure Credentials (never shown publicly)
    const credentials = {
      "Shiloh": "Olusegun",
      "Sophiat": "Busari",
      "Maria": "Gbadamosi",
      "Muhammed": "Jimoh",
      "Teacher": "Master"
    };

    const subjects = ['English Language','General Mathematics','Physics','Chemistry','Biology','Economics','Civic Education','Literature in English'];

    // Paste your FULL questionBank object here (example with 2 questions per subject)
    const questionBank = {
      'English Language': [
        { q: "Which of the following is a synonym for 'happy'?", opts: ["Sad", "Joyful", "Angry", "Tired"], ans: 1, exp: "'Joyful' means happy." },
        { q: "The capital of Nigeria is ___", opts: ["Lagos", "Abuja", "Kano", "Enugu"], ans: 1, exp: "Abuja is the capital city." }
        // Add your full 40+ questions per subject here
      ],
      'General Mathematics': [
        { q: "What is 15 + 27?", opts: ["32", "42", "52", "41"], ans: 1, exp: "15 + 27 = 42" },
        { q: "Simplify: 4 × (6 + 3)", opts: ["36", "27", "12", "54"], ans: 0, exp: "6 + 3 = 9, then 4 × 9 = 36" }
      ],
      // Add all other subjects with full questions...
    };

    // Utility
    function shuffleArray(a) { const b = [...a]; for (let i = b.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [b[i], b[j]] = [b[j], b[i]]; } return b; }
    function shuffleOptions(q) { const c = q.opts[q.ans]; const s = shuffleArray(q.opts); return { ...q, opts: s, ans: s.indexOf(c) }; }

    // Cloud Sync
    async function initSDK() {
      try {
        await window.dataSdk.init({ onDataChanged: d => { allAttempts = d || []; if (currentView === 'teacher-dashboard') render(); } });
        dataSdkInitialized = true;
      } catch (e) { console.log("Running in offline mode"); }
    }

    async function saveResult(r) {
      if (dataSdkInitialized) await window.dataSdk.create(r);
      else { const local = JSON.parse(localStorage.getItem('localResults') || '[]'); local.push({ ...r, id: Date.now() }); localStorage.setItem('localResults', JSON.stringify(local)); }
    }

    // Teacher Functions
    function addStudent(fn, sn) { if (!fn || !sn) return alert("Enter both fields"); if (credentials[fn]) return alert("Student already exists"); credentials[fn] = sn; alert("Student added!"); render(); }
    function changePass(fn, np) { if (!fn || !np) return alert("Select student and enter password"); if (!credentials[fn]) return alert("Student not found"); credentials[fn] = np; alert("Password updated!"); }

    // Login
    function handleLogin(e) {
      e.preventDefault();
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      if (credentials[u] === p) {
        currentUser = u;
        currentView = u === 'Teacher' ? 'teacher-dashboard' : 'subject-selection';
        render();
      } else {
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    // Exam Flow
    function selectSubject(s) {
      if (completedSubjects.includes(s)) return;
      if (selectedSubjects.includes(s)) selectedSubjects = selectedSubjects.filter(x => x !== s);
      else if (selectedSubjects.length < 5) selectedSubjects.push(s);
      render();
    }

    function startExam() {
      if (selectedSubjects.length !== 5) return alert("Select exactly 5 subjects");
      currentSubject = selectedSubjects[0];
      const q = questionBank[currentSubject] || [];
      currentExamQuestions = shuffleArray(q).slice(0, 40).map(shuffleOptions);
      timeRemaining = 40 * 60; currentQuestionIndex = 0; userAnswers = {}; tabSwitchCount = 0;
      currentView = 'exam'; startTimer(); render();
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeRemaining--;
        const el = document.getElementById('timer');
        if (el) {
          const m = String(Math.floor(timeRemaining/60)).padStart(2,'0');
          const s = String(timeRemaining%60).padStart(2,'0');
          el.textContent = `${m}:${s}`;
          if (timeRemaining <= 300) el.style.color = '#ef4444';
        }
        if (timeRemaining <= 0) submitExam(true);
      }, 1000);
    }

    async function submitExam(auto = false) {
      clearInterval(timerInterval);
      let score = 0;
      currentExamQuestions.forEach((q,i) => { if (userAnswers[i] === q.ans) score++; });
      const percentage = (score/40)*100;
      const grade = percentage >= 70 ? 'A' : percentage >= 60 ? 'B' : percentage >= 50 ? 'C' : percentage >= 45 ? 'D' : percentage >= 40 ? 'E' : 'F';

      await saveResult({ student_name: currentUser, subject: currentSubject, score, total: 40, percentage, grade, timestamp: new Date().toISOString() });

      completedSubjects.push(currentSubject);
      localStorage.setItem('completed', JSON.stringify(completedSubjects));
      selectedSubjects = selectedSubjects.filter(s => s !== currentSubject);
      window.currentScore = { score, percentage, grade, questions: currentExamQuestions, userAnswers };
      currentView = 'results';
      render();
    }

    function formatDate(iso) { return new Date(iso).toLocaleString('en-GB', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }); }

    // ==================== RENDER VIEWS ====================

    function renderLogin() {
      return `
        <div class="flex items-center justify-center min-h-screen">
          <div class="glass rounded-2xl p-10 w-full max-w-md shadow-2xl">
            <div class="text-center mb-10">
              <h1 class="text-4xl font-bold tracking-tight">Excellence Tutorial</h1>
              <p class="text-lg mt-3 opacity-90">SSS1 CBT Examination Portal</p>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-6">
              <input type="text" id="username" placeholder="Enter your username" required autocomplete="username"
                class="w-full px-5 py-4 rounded-xl glass text-white placeholder-gray-300 text-lg focus:ring-4 focus:ring-emerald-500 transition-all">
              <input type="password" id="password" placeholder="Enter your password" required autocomplete="current-password"
                class="w-full px-5 py-4 rounded-xl glass text-white placeholder-gray-300 text-lg focus:ring-4 focus:ring-emerald-500 transition-all">
              
              <div id="login-error" class="text-red-400 text-center font-medium hidden">Invalid username or password</div>

              <button type="submit" class="w-full py-5 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white font-bold text-xl transition-all transform hover:scale-105 active:scale-95 shadow-lg">
                Login to Portal
              </button>
            </form>

            <div class="mt-10 text-center text-sm opacity-70">
              <p>© 2025 Excellence Tutorial Centre</p>
              <p class="mt-2">Powered by Master Timothy</p>
            </div>
          </div>
        </div>`;
    }

    function renderSubjectSelection() {
      return `<div class="max-w-6xl mx-auto py-8"><div class="glass p-8">
        <div class="flex justify-between items-center mb-8">
          <h1 class="text-3xl font-bold">Welcome, ${currentUser}!</h1>
          <button onclick="logout()" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-xl font-semibold">Logout</button>
        </div>
        <p class="text-xl mb-6">Select exactly <strong>5 subjects</strong> to begin your exam</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
          ${subjects.map(s => `
            <button onclick="selectSubject('${s}')" ${completedSubjects.includes(s) ? 'disabled' : ''} 
              class="p-8 rounded-2xl text-center transition-all ${selectedSubjects.includes(s) ? 'glass ring-4 ring-emerald-500 shadow-xl' : 'glass-dark'} ${completedSubjects.includes(s) ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105 hover:shadow-2xl'}">
              <div class="text-xl font-bold">${s}</div>
              ${completedSubjects.includes(s) ? '<div class="mt-3 text-emerald-400 font-bold">Completed</div>' : ''}
            </button>`).join('')}
        </div>
        <button onclick="startExam()" ${selectedSubjects.length !== 5 ? 'disabled' : ''} 
          class="w-full py-6 text-2xl font-bold rounded-2xl transition-all ${selectedSubjects.length === 5 ? 'bg-emerald-500 hover:bg-emerald-600 shadow-xl' : 'bg-gray-700 cursor-not-allowed'}">
          Start Examination (${selectedSubjects.length}/5 selected)
        </button>
      </div></div>`;
    }

    function renderExam() {
      const q = currentExamQuestions[currentQuestionIndex];
      return `<div class="max-w-7xl mx-auto py-6"><div class="glass p-8">
        <div class="flex justify-between items-center mb-8">
          <div><h2 class="text-3xl font-bold">${currentSubject}</h2><p class="text-xl">Question ${currentQuestionIndex + 1} of 40</p></div>
          <div class="text-right"><div id="timer" class="text-4xl font-bold text-amber-400">40:00</div><p class="text-lg">Time Remaining</p></div>
        </div>
        <div class="glass-dark p-10 rounded-2xl mb-8">
          <p class="text-2xl mb-10 leading-relaxed">${q.q}</p>
          <div class="space-y-5">
            ${q.opts.map((opt, i) => `
              <button onclick="answerQuestion(${i})" class="w-full p-6 text-left rounded-xl text-lg transition-all ${userAnswers[currentQuestionIndex] === i ? 'ring-4 ring-emerald-500 glass shadow-xl' : 'glass-dark'} hover:scale-105">
                <span class="font-bold text-xl">${String.fromCharCode(65+i)}.</span> ${opt}
              </button>`).join('')}
          </div>
        </div>
        <div class="flex justify-between items-center">
          <button onclick="previousQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''} class="px-10 py-4 bg-gray-600 rounded-xl text-xl font-semibold">Previous</button>
          <button onclick="submitExam()" class="px-12 py-5 bg-amber-500 hover:bg-amber-600 rounded-xl text-xl font-bold shadow-xl">Submit Exam</button>
          <button onclick="nextQuestion()" class="px-10 py-4 bg-emerald-500 hover:bg-emerald-600 rounded-xl text-xl font-semibold">Next</button>
        </div>
      </div></div>`;
    }

    function renderResults() {
      const { score, percentage, grade } = window.currentScore;
      return `<div class="flex items-center justify-center min-h-screen"><div class="glass p-12 text-center max-w-2xl">
        <h1 class="text-6xl font-bold mb-10">Exam Completed!</h1>
        <div class="text-9xl font-black mb-6 text-emerald-400">${percentage.toFixed(1)}%</div>
        <div class="text-6xl font-bold mb-10"><span class="grade-badge grade-${grade}">${grade}</span></div>
        <p class="text-3xl mb-12">Score: ${score} out of 40</p>
        <button onclick="backToSelection()" class="w-full py-6 bg-emerald-500 hover:bg-emerald-600 rounded-2xl text-2xl font-bold shadow-xl">
          ${selectedSubjects.length > 0 ? 'Continue to Next Subject' : 'Back to Dashboard'}
        </button>
      </div></div>`;
    }

    function renderTeacherDashboard() {
      const students = Object.keys(credentials).filter(k => k !== 'Teacher');
      return `<div class="max-w-7xl mx-auto py-8"><div class="glass p-10">
        <div class="flex justify-between items-center mb-10">
          <div><h1 class="text-5xl font-bold">Teacher Dashboard</h1><p class="text-xl mt-2 opacity-90">Welcome, Master Timothy</p></div>
          <button onclick="logout()" class="px-8 py-4 bg-red-600 hover:bg-red-700 rounded-xl text-xl font-bold">Logout</button>
        </div>

        <div class="glass-dark p-8 rounded-2xl mb-10">
          <h2 class="text-3xl font-bold mb-6">Add New Student</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <input id="fn" placeholder="First Name" class="px-6 py-4 rounded-xl glass text-lg">
            <input id="sn" placeholder="Surname (Password)" class="px-6 py-4 rounded-xl glass text-lg">
            <button onclick="addStudent(document.getElementById('fn').value.trim(), document.getElementById('sn').value.trim()); document.getElementById('fn').value=''; document.getElementById('sn').value=''" class="bg-emerald-500 hover:bg-emerald-600 rounded-xl font-bold text-xl py-4">Add Student</button>
          </div>
        </div>

        <div class="glass-dark p-8 rounded-2xl">
          <h2 class="text-3xl font-bold mb-8">All Exam Results</h2>
          ${allAttempts.length === 0 ? 
            `<div class="text-center py-20"><div class="spinner"></div><p class="text-2xl mt-6">No submissions yet...</p></div>` :
            `<div class="overflow-x-auto"><table class="w-full text-left">
              <thead class="glass-dark"><tr><th class="p-6">Student</th><th class="p-6">Subject</th><th class="p-6">Score</th><th class="p-6">%</th><th class="p-6">Grade</th><th class="p-6">Date & Time</th></tr></thead>
              <tbody>
                ${allAttempts.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).map(a=>`
                  <tr class="border-t border-white/10 hover:bg-white/5 transition">
                    <td class="p-6 font-semibold">${a.student_name}</td>
                    <td class="p-6">${a.subject}</td>
                    <td class="p-6 text-center">${a.score}/40</td>
                    <td class="p-6 text-center font-bold text-emerald-400">${a.percentage.toFixed(1)}%</td>
                    <td class="p-6 text-center"><span class="grade-badge grade-${a.grade}">${a.grade}</span></td>
                    <td class="p-6 text-sm opacity-80">${formatDate(a.timestamp)}</td>
                  </tr>`).join('')}
              </tbody>
            </table></div>`
          }
        </div>
      </div></div>`;
    }

    function render() {
      const views = {
        login: renderLogin,
        'subject-selection': renderSubjectSelection,
        exam: renderExam,
        results: renderResults,
        'teacher-dashboard': renderTeacherDashboard
      };
      document.getElementById('app').innerHTML = views[currentView]() || '';
      if (currentView === 'exam') setTimeout(() => document.getElementById('timer')?.textContent, 100);
    }

    // Global Functions
    window.handleLogin = handleLogin;
    window.selectSubject = selectSubject;
    window.startExam = startExam;
    window.answerQuestion = i => { userAnswers[currentQuestionIndex] = i; render(); };
    window.previousQuestion = () => { if (currentQuestionIndex > 0) currentQuestionIndex--; render(); };
    window.nextQuestion = () => { if (currentQuestionIndex < 39) currentQuestionIndex++; render(); };
    window.submitExam = submitExam;
    window.backToSelection = () => { currentView = 'subject-selection'; render(); };
    window.logout = () => { currentUser = null; currentView = 'login'; selectedSubjects = []; render(); };
    window.addStudent = addStudent;
    window.changeStudentPassword = changePass;

    // Anti-Cheating
    document.addEventListener('visibilitychange', () => {
      if (currentView === 'exam' && document.hidden) {
        tabSwitchCount++;
        if (tabSwitchCount >= 2) {
          alert("Multiple tab switches detected — Exam auto-submitted!");
          submitExam(true);
        }
      }
    });

    // Start App
    initSDK().then(render);
  </script>
</body>
</html>
